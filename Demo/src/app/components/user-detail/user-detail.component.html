<div class="container-fluid min-vh-100 bg-light">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand" routerLink="/users">
        <i class="bi bi-people-fill me-2"></i>
        User Management
      </a>
      
      <div class="navbar-nav ms-auto">
        <div class="nav-item">
          <a class="nav-link text-white" routerLink="/users">
            <i class="bi bi-arrow-left me-1"></i>
            Back to Users
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        
        <!-- Loading Spinner -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Loading user details...</p>
        </div>

        <!-- User Detail Form -->
        <div *ngIf="!loading && user" class="card shadow">
          <div class="card-header" [class]="isOwnProfile ? 'bg-primary text-white' : 'bg-secondary text-white'">
            <h4 class="card-title mb-0">
              <i class="bi bi-person-gear me-2"></i>
              {{ isOwnProfile ? 'Edit Your Profile' : 'View User Profile' }}
              <span *ngIf="isOwnProfile" class="badge bg-light text-primary ms-2">Your Profile</span>
              <span *ngIf="!isOwnProfile" class="badge bg-light text-secondary ms-2">View Only</span>
            </h4>
          </div>
          
          <div class="card-body p-4">
            
            <!-- Success Message -->
            <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle me-2"></i>
              {{ successMessage }}
              <button type="button" class="btn-close" (click)="successMessage = ''"></button>
            </div>

            <!-- Error Message -->
            <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ errorMessage }}
            </div>

            <!-- User Info Header -->
            <div class="row mb-4">
              <div class="col-md-3 text-center">
                <!-- Avatar status indicator -->
                <div *ngIf="getPreviewAvatarUrl() && !isValidImageUrl(getPreviewAvatarUrl()!)" class="alert alert-warning p-1 mb-2" style="font-size: 0.7rem;">
                  <i class="bi bi-exclamation-triangle"></i> Invalid image URL
                </div>
                
                <div class="position-relative d-inline-block">
                  <img *ngIf="getPreviewAvatarUrl(); else defaultAvatar" 
                       [src]="getPreviewAvatarUrl()" 
                       [alt]="user && user.name ? user.name : 'User'"
                       class="rounded-circle border border-3 border-primary shadow"
                       width="120" 
                       height="120"
                       (error)="onAvatarError($event)"
                       (load)="onAvatarLoad($event)">
                  <ng-template #defaultAvatar>
                    <div class="rounded-circle border border-3 border-primary bg-light d-flex align-items-center justify-content-center"
                         style="width: 120px; height: 120px;">
                      <i class="bi bi-person-fill fs-1 text-muted"></i>
                    </div>
                  </ng-template>
                </div>
                <p class="text-muted mt-2 small">
                  <i class="bi bi-hash me-1"></i>ID: {{ user.id || user._id }}
                </p>
              </div>
              
              <div class="col-md-9">
                <h3 class="text-dark mb-2">{{ user.name }}</h3>
                <p class="text-muted mb-1">
                  <i class="bi bi-envelope me-2"></i>{{ user.email }}
                </p>
                <div class="mt-3">
                  <span *ngIf="isOwnProfile" class="badge bg-primary me-2">
                    <i class="bi bi-person-check me-1"></i>Your Account
                  </span>
                  <span class="badge bg-secondary">
                    <i class="bi bi-calendar me-1"></i>User #{{ user.id || user._id }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Edit Form -->
            <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="name" class="form-label fw-bold">
                      <i class="bi bi-person me-2"></i>Full Name *
                    </label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="name"
                      formControlName="name"
                      [class.is-invalid]="userForm.get('name')?.invalid && userForm.get('name')?.touched"
                      placeholder="Enter full name">
                    <div *ngIf="userForm.get('name')?.invalid && userForm.get('name')?.touched" class="invalid-feedback">
                      <small *ngIf="userForm.get('name')?.errors?.['required']">Name is required</small>
                      <small *ngIf="userForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</small>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="email" class="form-label fw-bold">
                      <i class="bi bi-envelope me-2"></i>Email Address
                    </label>
                    <input 
                      type="email" 
                      class="form-control" 
                      id="email"
                      formControlName="email"
                      readonly
                      title="Email cannot be changed">
                    <small class="form-text text-muted">
                      <i class="bi bi-info-circle me-1"></i>Email address cannot be changed
                    </small>
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <label for="avatarUrl" class="form-label fw-bold">
                  <i class="bi bi-image me-2"></i>Avatar URL (Optional)
                </label>
                <input 
                  type="url" 
                  class="form-control" 
                  id="avatarUrl"
                  formControlName="avatarUrl"
                  placeholder="https://example.com/avatar.jpg">
                <small class="form-text text-muted">
                  <i class="bi bi-info-circle me-1"></i>Enter a valid image URL for your profile picture
                </small>
                
                <div *ngIf="userForm.get('avatarUrl')?.value" class="mt-2">
                  <div *ngIf="isValidImageUrl(userForm.get('avatarUrl')?.value); else invalidUrl">
                    <small class="text-success">
                      <i class="bi bi-eye me-1"></i>Live preview shown in profile image above
                    </small>
                  </div>
                  <ng-template #invalidUrl>
                    <div class="alert alert-warning p-2 mb-0">
                      <small>
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Invalid URL:</strong> Please use a direct image URL (ending in .jpg, .png, .gif, etc.)
                        <br><strong>Example:</strong> https://picsum.photos/200/200
                      </small>
                    </div>
                  </ng-template>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="row">
                <div class="col-12">
                  <div class="d-flex gap-2 flex-wrap">
                    <button 
                      type="submit" 
                      class="btn btn-primary flex-fill flex-md-grow-0"
                      [disabled]="userForm.invalid || saving">
                      <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                      <i *ngIf="!saving" class="bi bi-check-lg me-2"></i>
                      {{ saving ? 'Saving...' : 'Save Changes' }}
                    </button>
                    
                    <button 
                      *ngIf="!isOwnProfile"
                      type="button" 
                      class="btn btn-danger flex-fill flex-md-grow-0"
                      [disabled]="saving"
                      (click)="onDeleteUser()">
                      <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                      <i *ngIf="!saving" class="bi bi-trash me-2"></i>
                      {{ saving ? 'Deleting...' : 'Delete User' }}
                    </button>
                    
                    <button 
                      type="button" 
                      class="btn btn-outline-secondary flex-fill flex-md-grow-0"
                      (click)="goBack()">
                      <i class="bi bi-arrow-left me-2"></i>
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Error State -->
        <div *ngIf="!loading && !user" class="text-center py-5">
          <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
          <h3 class="text-danger mt-3">User Not Found</h3>
          <p class="text-muted">The requested user could not be found or you don't have permission to view it.</p>
          <button class="btn btn-primary" (click)="goBack()">
            <i class="bi bi-arrow-left me-2"></i>
            Back to Users
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<app-confirm-delete
  [isVisible]="showConfirmDelete"
  [title]="'Delete User'"
  [message]="'Are you sure you want to delete this user?'"
  [itemName]="user?.name || ''"
  [confirmText]="'Delete User'"
  [cancelText]="'Cancel'"
  [isLoading]="deleting"
  (confirm)="confirmDeleteUser()"
  (cancel)="cancelDeleteUser()">
</app-confirm-delete>
